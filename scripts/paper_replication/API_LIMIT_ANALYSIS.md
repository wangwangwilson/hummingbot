# API限流问题分析

## 问题根源

### 1. API限流原因（429错误）

**Binance API限制**:
- 限制: 2400 requests per minute per IP
- 当前问题: 并发请求过多，超过限制

**请求来源分析**:
1. **初始化阶段**（每个交易对）:
   - `initialize_exchange_data()`: 需要API调用
   - `initialize_trading_rules()`: 需要API调用获取exchangeInfo
   - 每个交易对: 约2-3次API调用

2. **数据获取阶段**（每个交易对）:
   - `get_historical_candles()`: 需要多次API调用
   - 1天数据（1440条K线）需要: 1440 / 1500 ≈ 1次API调用
   - 但如果有多个策略，每个策略都需要获取数据

3. **并发执行**:
   - 7个交易对 × 2个策略 = 14个并发任务
   - 每个任务需要: 2-3次初始化 + 1-2次数据获取 = 3-5次API调用
   - 总请求数: 14 × 4 = 56次并发请求
   - **问题**: 如果所有请求同时发起，可能瞬间超过限制

### 2. 数据获取失败原因

**参考价格为0的问题**:
1. **API限流导致数据获取失败**:
   - 429错误 → 数据获取失败 → 返回空DataFrame
   - `update_processed_data()`检测到空DataFrame → 设置reference_price = 0

2. **数据获取逻辑问题**:
   - `get_candles_df()`从`candles_feeds`字典获取
   - 如果数据获取失败，字典中可能没有数据
   - 返回空DataFrame

3. **时间范围问题**:
   - 警告显示"No candles fetched for time range"
   - 可能是时间戳转换问题或API返回空数据

## 解决方案

### 方案1: 减少并发数 + 添加延迟（已实现）
- 将并发数从8减少到4
- 每个任务添加0.5秒延迟
- 完成后添加0.2秒延迟

### 方案2: 添加请求重试机制
- 检测429错误
- 自动重试（带指数退避）

### 方案3: 数据获取验证
- 在回测前验证数据获取
- 如果数据为空，不进行回测

### 方案4: 使用本地缓存
- 如果数据已下载，使用本地CSV
- 减少API调用

---

**分析时间**: 2025-11-13  
**状态**: 已实现方案1，需要验证效果

